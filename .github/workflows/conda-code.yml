name: Regression Tests with fleur installed from conda

on: [push, pull_request]

jobs:

  tests:

    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        python-version: ["3.8", "3.10"]
        aiida: [{version: 'aiida-core==1.6.8', name: '1.6.8'}, {version: 'aiida-core==2.0.1', name: '2.0.1'}]
        masci-tools: [{version: 'masci-tools', name: 'stable'}]
        fleur-version: [{version: "6.0", name: 'MaX-R6'}]
        allowed-to-fail: [false]
      fail-fast: false

    name: conda-tests-python-${{ matrix.python-version }}-fleur-${{ matrix.fleur.version }}-aiida-${{ matrix.aiida.name }}-masci-${{ matrix.masci-tools.name }}
    continue-on-error: ${{ matrix.allowed-to-fail }}

    services:
      postgres:
        image: postgres:10
        env:
          POSTGRES_DB: test_${{ matrix.backend }}
          POSTGRES_PASSWORD: ''
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
        - 5432:5432
      rabbitmq:
        image: rabbitmq:latest
        ports:
        - 5672:5672

    steps:
    - uses: actions/checkout@v2

    - name: Cache python dependencies
      id: cache-pip
      uses: actions/cache@v1
      with:
        path: ~/.cache/pip
        key: pip-${{ matrix.python-version }}-${{ matrix.aiida.name }}-tests-${{ hashFiles('**/setup.json') }}
        restore-keys: |
          pip-${{ matrix.python-version }}-${{ matrix.aiida.name }}-tests

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install postgresql

    - name: Install python dependencies
      run: |
        pip install --upgrade wheel setuptools
        pip install git+https://github.com/JuDFTteam/aiida-testing.git@export_cache_config
        pip install .[testing,graphs]
        pip install ${{ matrix.aiida.version }}
        pip install ${{ matrix.masci-tools.version }}
        reentry scan || true

    - name: Setup Conda
      uses: s-weigand/setup-conda@v1
      with:
        conda-channels: conda-forge
        update-conda: true
        python-version: ${{ matrix.python-version }}

    - name: Install mamba
      run: |
        conda --version
        conda install mamba

    - name: Install Fleur code from conda
      run: |
        mamba install fleur=${{ matrix.fleur.version }}
        fleur_MPI -h
        inpgen -h

    - name: Remove workflow caches
      run: |
        cd ./tests/
        mv .aiida-testing-conda-config.yml .aiida-testing-config.yml
        rm -rf workflows/caches/* workflows/calculations/*
        rm -rf calculations/calculations/*

    - name: Run pytest
      run: |
       cd ./tests/
       mv .aiida-testing-conda-config.yml .aiida-testing-config.yml
       ./run_all_cov.sh --local-exe-hdf5 --export-cache-allow-migration

    - name: Upload report to Codecov
      uses: codecov/codecov-action@v1
      with:
        file: ./tests/coverage.xml
        fail_ci_if_error: False